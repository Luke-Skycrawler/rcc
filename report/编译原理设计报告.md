<h1 style='text-align: center'>编译原理设计报告</h1>
<p style='text-align: center'>谢廷浩 3180101944<br/>石昊洋 3180102686</p>



[toc]

# 1. 引言

## 1.1 概述

编译原理课程大作业要求完成一个**编译器**。我们在本次课程大作业中，设计并实现了[rcc](https://github.com/Luke-Skycrawler/rcc)，一个类C语言编译器。该编译器基于FLEX进行词法分析、BISON进行语法分析、LLVM实现中间码生成及目标码生成。rcc支持的语言与C不同之处主要在于：

* 只支持char、int、double，和由它们构成的（多维）数组、结构体，以及数组、结构体间彼此的嵌套组合。**不支持指针等直接地址访问**。

* 不支持包括`jump`、`goto`、`break`、`continue`、`switch`等控制语句。

* `scanf`、`printf`会在编译时自动声明、链接，可以直接使用。注意，`scanf`的调用与C不同，无需通过`&`取变量地址，可以直接使用`scanf("%d", i)`从输入读入变量值。

* `for`循环需要使用类似Pascal的语法：

  ```pascal
  for(i: 0 to n)
  {
  	...
  }
  
  for(i: n downto 0)
  {
  	...
  }
  ```

  循环变量只在`for`语句循环体中有效。

* 不支持前缀表达式

具体的rcc语言语法可以在源代码目录下的`ebnf.txt`查看。

除了基本功能外，我们实现的**进阶主题**包括但不限于：

1. 自定义`struct`类型，可以与基本类型、结构体、基本类型或结构体的数组任意嵌套使用

2. 支持宏定义，包括

   ```C
   #define
   #define f(X)
   #ifdef
   #ifndef
   ```

3. 支持简单的错误检测、定位

## 1.2 环境

由于依赖的架构较复杂，建议在Linux、MacOS上编译运行rcc。

建议的依赖版本包括：

* flex 2.5+
* bison 3.0+
* clang 7.0+
* llvm 7.0+

已经成功测试能够编译运行rcc的版本包括：

* flex 2.6.4 + bison 3.0.4 + llvm-12 on Ubuntu 18.04 (x86_64)
* flex 2.5.35 + bison 3.7.6 + llvm-12 on MacOS (x86_64)

## 1.3 文件目录

本次实验提交的文件说明如下：

```
/ #根目录
	--rcc/ #源代码目录
		#rcc主体文件
    --Makefile #编译rcc
    --rcc.l #rcc词法分析flex文件
    --rcc.ypp #rcc语法分析bison文件
    --AST.hpp/cpp #AST树定义、声明
    --CodeGen.h/cpp #LLVM中间代码生成文件
    --RccGlobal.hpp #rcc语法、词法分析用到的全局环境
    --main.cpp #入口文件
    --macro.l #宏定义词法分析flex文件
    --macro.ypp #宏定义语法分析bison文件
    --macro.cpp #宏定义cpp文件
    --ebnf.txt #rcc语言ebnf语法规则说明
    --README.md #README说明
		--test/ #测试文件目录
			--array.c
			--assign.c
			--auto-advisor.c
			--binOp.c
			--declaration.c
			--define.c
			--easy.c
			--for_test.c
			--if_test.c
			--matrix-multiplication.c
			--matrixMul.c
			--naive_test.c
			--naive_test_ast_output.txt #可视化AST树输出
			--qsort.c
			--quicksort.c
			--recursive.c
			--ref_binOp.c
			--scanf_test.c
			--struct.c
			--struct_array.c
			--type_check.c
			--variable_access.c
			--while_test.c
	--report.pdf #该报告
    
```

## 1.4 分工

编译器前后端耦合度较高，组员二人对词法分析、语法分析、中间码生成、测试都有着差不多的贡献，不展开说明。

# 2. 词法分析

词法分析中，编译器读入源程序字符串，解析后返回token（标记）；返回的token会在下一步被语法分析所利用。

## 2.1 Flex

rcc的词法分析使用flex完成。flex可以匹配用户指定的正则表达式，并结合bison返回token。lex文件由三部分组成：

* 定义区
* 规则区
* 用户子过程区

```
{definitions}
%%
{rules}
%%
{user subroutines}
```

Flex的具体使用、正则语言等理论知识不在此赘述。

## 2.2 具体实现



# 3. 语法分析



# 4. 语义分析（中间码生成）



# 5. 目标代码及可执行文件生成



# 6. 测试





